name: cnip-cidr-auto
on:
  schedule:
    - cron: '0 12 */2 * *'  # UTC 12:00 每2天执行 = 北京时间 20:00
  workflow_dispatch:      # 支持手动触发测试

# 核心修复：授予工作流读写仓库权限，解决 git push 失败
permissions:
  contents: write
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: ${{ github.workspace }}/routeros-cnip-cidr
          fetch-depth: 0
          # 新增：使用令牌检出，保证后续可推送
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update cn_ip_cidr.rsc
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |-
          bash $GITHUB_WORKSPACE/routeros-cnip-cidr/generator.bash

      # 核心优化：删除RouterOS IPv6兼容性判断行，带调试日志
      - name: Remove IPv6 package check line
        run: |-
          cd $GITHUB_WORKSPACE/routeros-cnip-cidr/
          FILE_PATH="dist/cn_ip_cidr.rsc"

          # ========== 调试：执行删除前检索目标行 ==========
          echo "[DEBUG] 开始检索目标代码行"
          grep -n "system package find where name=\"ipv6\"" "$FILE_PATH" || echo "[DEBUG] 未检索到目标行"

          # ========== 核心命令：宽松匹配删除 ==========
          sed -i '/system package find where name="ipv6"/d' "$FILE_PATH"

          # ========== 调试：执行删除后二次验证 ==========
          echo "[DEBUG] 删除完成，二次校验结果"
          grep -n "system package find where name=\"ipv6\"" "$FILE_PATH" || echo "[SUCCESS] 目标代码行已彻底删除"

          # 预览文件头部，确认格式正常
          echo "[DEBUG] 脚本文件前20行预览："
          head -20 "$FILE_PATH"

      - name: Commit and push if changed
        run: |-
          cd $GITHUB_WORKSPACE/routeros-cnip-cidr/
          git diff
          # 配置Git用户信息
          git config --global user.email "action_bot@rookiezoe.com"
          git config --global user.name "ActionBot"
          # 提交所有变更
          git add -A
          # 修复文案：hourly → every 2 days，匹配定时规则
          git commit -m "Auto update IP list + remove IPv6 check line [every 2 days]" || exit 0
          # 修复推送命令：使用官方令牌认证推送
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
